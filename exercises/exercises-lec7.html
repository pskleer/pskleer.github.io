<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Exercises Lecture 7 (Chapter 9)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="exercises-lec7_files/libs/clipboard/clipboard.min.js"></script>
<script src="exercises-lec7_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="exercises-lec7_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="exercises-lec7_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="exercises-lec7_files/libs/quarto-html/popper.min.js"></script>
<script src="exercises-lec7_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="exercises-lec7_files/libs/quarto-html/anchor.min.js"></script>
<link href="exercises-lec7_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="exercises-lec7_files/libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="exercises-lec7_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="exercises-lec7_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="exercises-lec7_files/libs/bootstrap/bootstrap-d97c7a1f32f046112b36cb8508ca8758.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="style.css">
</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="exercises-lec7.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Exercises Lecture 7 (Chapter 9)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""> <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&amp;family=Fira+Sans&amp;display=swap" rel="stylesheet"></p>
<p>Make sure to import Numpy, SciPy and Matplotlib to be able to complete all the exercises.</p>
<div id="b973af42" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.optimize <span class="im">as</span> optimize</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.interpolate <span class="im">as</span> interpolate</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats <span class="co"># Could import this as, e.g., stats as well</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display numerical values in NumPy arrays only up to three decimals, </span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># and suppress scientific notation</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(precision<span class="op">=</span><span class="dv">3</span>, suppress<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<blockquote class="blockquote">
<p><b>Disclaimer:</b> For some questions where random numbers are involved, it might happen that your output obtained from running the test input is different than the output given. <br><br> This can happen if, despite the use of a random seed, you generate random numbers in a different way than was done in the solution by the teacher. This does not necessarily mean that your answer is wrong. If you are unsure about your solution, ask the teacher. <br><br> As an example, you can generate a normally distributed random number with mean <span class="math inline">0</span> and standard deviation <span class="math inline">1</span> with <code>np.random.normal(0,1)</code> or <code>np.random.randn()</code>, but these numbers will usually be different. Also, the shape of an array that you fill with random numbers can have an influence on the outcome: The command <code>np.random.randn(3,4)</code> does not yield the same <span class="math inline">3 \times 4</span> array as <code>np.random.randn(4,3).T</code>.</p>
</blockquote>
<section id="question-1" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="question-1">Question 1</h4>
<p>In this question, we will compute a coefficient that can be used to give an indication whether two arrays of samples have the same median or not. Do not use for-loops in this exercise.</p>
<ol type="a">
<li><p>Define a function <code>compare_median()</code> that takes as inputs two one-dimensional arrays <span class="math inline">x</span> and <span class="math inline">y</span> of equal size. It should compute the sample medians <span class="math inline">s_x</span> and <span class="math inline">s_y</span> of <span class="math inline">x</span> and <span class="math inline">y</span>, respectively, and output the number <span class="math inline">|s_x - s_y|</span>. <br><br> Test your function on two randomly generated arrays <span class="math inline">x</span> and <span class="math inline">y</span> with <span class="math inline">n = 50</span> normally distributed samples in each. The array <span class="math inline">x</span> has <span class="math inline">\mu = 0</span> and <span class="math inline">\sigma = 1</span>; and <span class="math inline">y</span> has <span class="math inline">\mu = 0</span> and <span class="math inline">\sigma = 2</span>. Take random Numpy seed <span class="math inline">s = 3.</span> For the given random seed, the output should be <span class="math inline">\approx 0.66</span>. <br><br> The closer the number is to <span class="math inline">0</span>, the more likely it is that the sample arrays come from a distribution with the same median, which is indeed the case for us.</p></li>
<li><p>Vectorize your function so that it can take as input a two-dimensional <span class="math inline">k \times n</span> array, and outputs a matrix <span class="math inline">M = (m_{ij})</span> whose entry <span class="math inline">m_{ij}</span> has the output of the function <code>compare_median()</code> applied to the data on rows <span class="math inline">i</span> and <span class="math inline">j</span>, for all <span class="math inline">i,j =0 ,\dots,k-1</span>.<br> <i>Hint: If you substract a row <span class="math inline">(k,)</span>-shaped array from a <span class="math inline">(k,1)</span>-shaped column array, then the resulting two-dimensional array contains all the pairwise differences of the two arrays.</i></p></li>
<li><p>Create a function <code>unif_samples</code> that takes as input two one-dimensional arrays <span class="math inline">a = [a_0,\dots,a_{m-1}]</span> and <span class="math inline">b = [b_0,\dots,b_{m-1}]</span>, and a number <span class="math inline">n</span>. It should output a two-dimensional <span class="math inline">m \times n</span> array where row <span class="math inline">i</span> contains <span class="math inline">n</span> samples from the (continuous) uniform distribution on <span class="math inline">[a_i,b_i]</span> for <span class="math inline">i = 0,\dots,m-1</span>.<br> <i>Hint: Have a look at Chapter 8.2.1 how to generate samples from different distributions from the same family and a look at the <a href="https://numpy.org/doc/2.0/reference/random/generated/numpy.random.uniform.html">documentation</a> here to check out the keyword arguments of <code>np.random.uniform</code>. </i></p></li>
</ol>
<p>Test your functions from b) and c) by applying them to the test input below.</p>
<div id="141da7ec" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix random seed</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>np.random.seed(s)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Input parameters</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> [<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">5</span>]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> [<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">9</span>]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Testing function</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> unif_samples(a,b,n)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(compare_median(samples)) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[0.    2.48  0.089 4.71 ]
 [2.48  0.    2.569 2.23 ]
 [0.089 2.569 0.    4.799]
 [4.71  2.23  4.799 0.   ]]</code></pre>
</div>
</div>
</section>
<section id="question-2" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="question-2">Question 2</h4>
<p>Consider a multivariate linear regression model of the form <span class="math display">
y_i = f(x_i,\beta) + \epsilon_i
</span> where <span class="math inline">(x_i,y_i)</span> are known data points with <span class="math inline">x_i = [x_{i0},\dots,x_{i(n-1)}] \in \mathbb{R}^{n}</span> and <span class="math inline">y_i \in \mathbb{R}</span>. The variables to be fitted are contained in the array <span class="math inline">\beta = [\alpha,\beta_0,\dots,\beta_{n-1}] \in \mathbb{R}^{n+1}</span>. The function <span class="math inline">f</span> is given by <span class="math display">
f(x_i,\beta) = \alpha + \beta_0x_{i0} + \dots + \beta_{n-1}x_{i(n-1)}.
</span></p>
<ol type="a">
<li>Write a function <code>linear_regression</code> that takes as input <span class="math inline">m</span> data points <span class="math inline">(x_i,y_i)</span>, in the form of a two-dimensional array <span class="math inline">x</span> that has the <span class="math inline">x_i</span> on its rows, and a one-dimensional array <span class="math inline">y = [y_0,\dots,y_{m-1}]</span>. It should output <br></li>
</ol>
<ul>
<li>The fitted vector <span class="math inline">\beta</span> on this data using <code>least_squares()</code> with initial guess the all-ones array <span class="math inline">[1,1,\dots,1]</span>.</li>
<li>The sum of the squared errors <span class="math inline">\sum_{i=0}^{m-1} (y_i - f(x_i,\beta))^2</span>.<br><br></li>
</ul>
<p>Test your function on the following input. <!-- Code below was used to generate the input x and y --></p>
<div id="364a0bb3" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">1.012</span>,  <span class="fl">1.008</span>,  <span class="fl">0.996</span>,  <span class="fl">0.998</span>],</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">1.992</span>,  <span class="fl">1.996</span>,  <span class="fl">2.015</span>,  <span class="fl">1.995</span>],</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">3.007</span>,  <span class="fl">2.996</span>,  <span class="fl">2.988</span>,  <span class="fl">2.998</span>],</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">3.991</span>,  <span class="fl">4.02</span> ,  <span class="fl">4.002</span>,  <span class="fl">3.979</span>],</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">5.004</span>,  <span class="fl">4.998</span>,  <span class="fl">4.996</span>,  <span class="fl">4.988</span>],</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">5.988</span>,  <span class="fl">6.</span>   ,  <span class="fl">6.011</span>,  <span class="fl">6.005</span>],</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">7.</span>   ,  <span class="fl">7.</span>   ,  <span class="fl">6.994</span>,  <span class="fl">7.011</span>],</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">8.002</span>,  <span class="fl">8.011</span>,  <span class="fl">8.002</span>,  <span class="fl">7.997</span>],</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">8.984</span>,  <span class="fl">9.022</span>,  <span class="fl">8.992</span>,  <span class="fl">9.02</span> ],</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>       [ <span class="fl">9.99</span> ,  <span class="fl">9.99</span> ,  <span class="fl">9.999</span>, <span class="fl">10.009</span>]])</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.array([<span class="fl">11.014</span>, <span class="fl">20.045</span>, <span class="fl">28.928</span>, <span class="fl">38.03</span> , <span class="fl">46.977</span>, </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                <span class="fl">56.022</span>, <span class="fl">64.983</span>, <span class="fl">74.038</span>, <span class="fl">83.024</span>, <span class="fl">91.977</span>])</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Test your function on the x and y as above</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>beta_fit, error <span class="op">=</span> linear_regression(x,y)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Print parameters</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fitted parameters:"</span>, beta_fit)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Print error</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sum of squares error:"</span>,error)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitted parameters: [1.99  1.258 2.584 4.449 0.71 ]
Sum of squares error: 0.0005592236239135366</code></pre>
</div>
</div>
<p>Instead of minimizing the sum of squares we will next search for coefficients that minimize the sum of the absolute differences for <span class="math inline">m</span> given data points. That is, we want find an array <span class="math inline">\beta</span> that minimizes the expression <span class="math display">
\min_{\beta} \sum_{i=0}^{m-1} |y_i - f(x_i,\beta)|.
</span> with <span class="math inline">f</span> as above.</p>
<ol start="2" type="a">
<li><p>Write a function <code>abs_regression()</code> that takes as input data points <span class="math inline">(x_i,y_i)</span>, as in part a), and outputs the fitted array <span class="math inline">\beta</span> that solves the minimization problem above, as well as the sum of the absolute errors for the optimal <span class="math inline">\beta</span>. Use <code>optimize.minimize()</code> in your solution with again the all-ones vector as initial guess.</p></li>
<li><p>Test your functions in parts a) and b) on the input data below (that contains one “outlier”).</p></li>
</ol>
<div id="fb3aae7c" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># x_i data</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.array([ <span class="fl">1.124</span>,  <span class="fl">1.965</span>,  <span class="fl">3.162</span>,  <span class="fl">4.381</span>,  <span class="fl">4.941</span>,  </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                <span class="fl">5.941</span>,  <span class="fl">7.395</span>,  <span class="fl">8.192</span>, <span class="fl">8.883</span>, <span class="fl">10.136</span>])</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> x[:,<span class="va">None</span>] <span class="co"># x_i-data has to be inputted per row</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># y_i data</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.array([<span class="fl">0.884</span>, <span class="fl">1.884</span>, <span class="fl">3.06</span> , <span class="fl">3.522</span>, <span class="fl">14.569</span>,   <span class="co">#Outlier: 14.569 = 4.569 + 10</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                <span class="fl">5.859</span>, <span class="fl">6.747</span>, <span class="fl">8.079</span>, <span class="fl">8.773</span>, <span class="fl">9.647</span>]) </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit sums of squares error</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>beta_squares, error_squares <span class="op">=</span> linear_regression(x,y)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sum of squares fit gives beta="</span>, </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        beta_squares, <span class="st">"with error"</span>, error_squares)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit sum of differences error        </span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>beta_abs, error_abs <span class="op">=</span> abs_regression(x,y)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sum of absolute differences fit gives beta="</span>, </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        beta_abs, <span class="st">"with error"</span>, error_abs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sum of squares fit gives beta= [1.223 0.905] with error 88.69264159225709
Sum of absolute differences fit gives beta= [-0.091  0.997] with error 11.590128506427407</code></pre>
</div>
</div>
<ol start="4" type="a">
<li>Plot the fitted lines in a figure together with the data points. The figure should look like this:</li>
</ol>
<div id="079bb98d" class="cell" data-execution_count="10">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="exercises-lec7_files/figure-html/cell-11-output-1.png" width="585" height="449" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looking at the figure, one might argue that if we ignore the outlier close to <span class="math inline">(4.941,14.569)</span>, the line found by minimizing the absolute differences of the errors fits the remaining data better than the line found by minimizing the sum of squared errors. This is typically the case when data contains outliers.</p>
</section>
<section id="question-3" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="question-3">Question 3</h4>
<p>In this question we will consider Lasso regression, where the goal is to fit the so-called Lasso error</p>
<p><span class="math display">
\min_{\beta} \frac{1}{m}\sum_{i=0}^{m-1} (y_i - f(x_i,\beta))^2 + \gamma \sum_{i=0}^{k-1} |\beta_i|.
</span></p>
<p>with <span class="math inline">\gamma\geq 0</span> a given constant and <span class="math inline">f(x_i,\beta) = \beta_0x_{i0} + \dots + \beta_{n-1}x_{i(n-1)}</span>. This is almost the same function as in Question 2, but without the constant term <span class="math inline">\alpha</span>. The error objective above is more likely to set some <span class="math inline">\beta_i</span> close to zero than normal least squares regresssion (that only minimizes the first term in the formula above).</p>
<p>This can be useful if you want to find the important features in your data set. Let us first generate some synthetic data to explain what is meant with “important” features. Note that in the code below each row <span class="math display">
x_i = [x_{i0}, x_{i1}, x_{i2}, x_{i3}, x_{i4}]
</span> in the array <span class="math inline">x</span> is considered a data point five elements, each representing a feature.</p>
<div id="2829930b" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix random seed</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">3</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Function f</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(x,beta):</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Input: - x is two-dimensional array with data on the rows</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#        - beta is array of coefficients to be fitted</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">@</span> beta</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># True beta used for data generation</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>beta_true <span class="op">=</span> np.array([<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">3</span>,<span class="dv">0</span>])</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> <span class="dv">10</span><span class="op">;</span> <span class="co"># number of samples</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> np.size(beta_true) <span class="co"># number of features</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Generation of data array with </span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co"># points close to (1,...,1), (2,...,2), .., (m,...,m)</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">1</span>,m<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.repeat(x,repeats<span class="op">=</span>n).reshape(m,n)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> x <span class="op">+</span> np.random.randn(m,n) </span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co"># y-data</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> f(x,beta_true) <span class="op">+</span> np.random.randn(m)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Above, we generate synthetic data where the “true” values of the parameters to be fitted are <span class="math inline">\beta = [\beta_0,\dots,\beta_4] = [2,1,0,3,0]</span>. Note that <span class="math inline">\beta_2 = \beta_4 = 0</span>, which means that the second and fourth feature essentially play no role in the data. The synthetic data is created based on this vector <span class="math inline">\beta</span> with some random noise added to it, which means that once we do the fitting we will not find back exactly the “true” values. Make sure you understand this concept.</p>
<ol type="a">
<li><p>Write a function <code>lasso_regression()</code> that takes as input a two-dimensional array <span class="math inline">x</span> whose rows represent the data <span class="math inline">x_i</span> for <span class="math inline">0 = 1,\dots,m-1</span>, a one-dimensional array <span class="math inline">y = [y_0,\dots,y_{m-1}]</span>, and a constant <span class="math inline">\gamma \geq 0</span>. It should output the fitted array <span class="math inline">\beta</span> that solves the minimization problem above, as well as the Lasso error. Use <code>optimize.minimize()</code> in your solution with again the all-ones vector as initial guess.</p></li>
<li><p>Test your function on the synthetic data generated above for <span class="math inline">\gamma \in \{0, 0.1, 0.2, \dots, 0.9\}</span>, and output a <span class="math inline">10 \times 5</span> array with the values of the fitted <span class="math inline">\beta</span> for <span class="math inline">\gamma_i = 0.1 \cdot i</span> on row <span class="math inline">i</span>. You may use a for-loop here. <br><br> Your output should look like below.</p></li>
</ol>
<div id="9b3cb251" class="cell" data-execution_count="13">
<div class="cell-output cell-output-stdout">
<pre><code>[[ 2.42   1.413  0.49   3.445 -1.85 ]
 [ 2.329  1.409  0.382  3.372 -1.578]
 [ 2.238  1.404  0.275  3.299 -1.306]
 [ 2.147  1.4    0.167  3.226 -1.034]
 [ 2.056  1.396  0.06   3.153 -0.762]
 [ 1.969  1.381 -0.     3.079 -0.531]
 [ 1.861  1.378 -0.     2.991 -0.339]
 [ 1.806  1.325 -0.     2.932 -0.17 ]
 [ 1.735  1.293 -0.     2.863 -0.001]
 [ 1.72   1.308 -0.     2.858 -0.   ]]</code></pre>
</div>
</div>
<p>As <span class="math inline">\gamma</span> increases we see that <span class="math inline">\beta_2, \beta_4 \rightarrow 0</span>. Be aware though, that if you choose <span class="math inline">\gamma</span> too large, then other <span class="math inline">\beta_i</span> values might also converge to <span class="math inline">0</span>. As an extreme case, if <span class="math inline">\gamma = 1000</span>, then all coefficients will be <span class="math inline">0</span>. Do you understand why?</p>
<div id="772ee3a3" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>beta_fit, error_fit <span class="op">=</span> lasso_regression(x,y,<span class="dv">1000</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(beta_fit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[-0. -0. -0.  0.  0.]</code></pre>
</div>
</div>
<p>Deciding which <span class="math inline">\gamma</span> to use is called <i>hyperparameter tuning</i>. This topic plays an important role not only in regression problems, but more broadly in data science and machine learning.</p>
</section>
<section id="question-4" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="question-4">Question 4</h4>
<p>Reproduce the figure below, that displays interpolation of the function <span class="math inline">f(x) = \cos(x)</span> using piecewise polynomials of degrees <span class="math inline">k = 0,1,2,3</span> on the intervals between the given data points. The <span class="math inline">x</span>-value of the data points (the dots) are <span class="math inline">[-10, -7, -3, -1, 0, 1, 3, 7, 8, 10]</span>.</p>
<div id="5c78a11a" class="cell" data-execution_count="15">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="exercises-lec7_files/figure-html/cell-16-output-1.png" width="662" height="468" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="question-5" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="question-5">Question 5</h4>
<p>In this exercise we will implement the maximum log-likelihood estimation procedure for a normal distribution with unknown mean <span class="math inline">\mu</span> and standard deviation <span class="math inline">\sigma</span>. Recall that the idea of maximum log-likelihood estimation is to find, based on an array of samples <span class="math inline">x = [x_0,\dots,x_{n-1}]</span>, parameters <span class="math inline">\mu</span> and <span class="math inline">\sigma</span> that solve the problem <span class="math display">
\max_{\mu,\sigma} L(\mu,\sigma,x) = \sum_{i=0}^{n-1} \log(f(x_i,\mu,\sigma))
</span> where <span class="math inline">f(x,\mu,\sigma)</span> is the probability density function of the normal distribution with mean <span class="math inline">\mu</span> and standard deviation <span class="math inline">\sigma</span>. The idea is that the parameters maximizing the function above are the ones that are most likely to yield the samples in the array <span class="math inline">x</span>.</p>
<p>Write a function <code>norm_likelihood()</code> that takes as input a one-dimensional array <span class="math inline">x = [x_0,\dots,x_{n-1}]</span> of samples, and outputs parameters <span class="math inline">\mu</span> and <span class="math inline">\sigma</span> that maximize the function <span class="math inline">L</span> above for the given <span class="math inline">x</span>. Use the <code>optimize.minimize()</code> method for optimizing <span class="math inline">L</span> and take as initial guess the mean and standard deviation of the vector <span class="math inline">x</span>.</p>
<p>Test your function on the input below.</p>
<div id="f55913f1" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix random seed</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">3</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate some samples</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.normal(loc<span class="op">=</span><span class="dv">3</span>,scale<span class="op">=</span><span class="dv">5</span>,size<span class="op">=</span><span class="dv">10</span>) <span class="co"># 10 samples</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-likelihood estimation</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> norm_likelihood(x)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Solution found by maximum likelihood estimation:"</span>,y)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Solution found by maximum likelihood estimation: [2.298 4.332]</code></pre>
</div>
</div>
<p>The (rounded) solution found is the same as the one found by the <code>fit()</code> function.</p>
<div id="c78e55a6" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Comparison with fit()</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> scipy.stats.norm.fit(x)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Solution found by fit() function:"</span>,y)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Solution found by fit() function: (np.float64(2.2976087746123506), np.float64(4.332072061724699))</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>